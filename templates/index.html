<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ“ˆ Event Logger Dashboard</title>

<!-- TailwindCSS -->
<script src="https://cdn.tailwindcss.com"></script>
<script>
  tailwind.config = { darkMode: 'class' }
</script>

<!-- Socket.IO & Chart.js -->
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-100">

<div class="container mx-auto p-4">
  <div class="flex justify-between items-center mb-4">
    <h1 class="text-3xl font-bold">ğŸ“Š Event Logger Dashboard</h1>

    <div class="flex gap-2">
      <button onclick="toggleDarkMode()" class="px-3 py-1 bg-gray-800 text-white rounded shadow dark:bg-gray-200 dark:text-black">
        ğŸŒ™ Dark Mode
      </button>
      <button onclick="openOnos()" class="px-3 py-1 bg-blue-600 text-white rounded shadow">
        ğŸ›°ï¸ Ouvrir ONOS
      </button>
    </div>
  </div>

  <div class="mb-4">
    <label class="mr-2">Filtrer par device:</label>
    <select id="deviceFilter" onchange="updateTable()" class="border rounded px-2 py-1">
      <option value="">Tous</option>
    </select>

    <input id="searchInput" placeholder="Rechercherâ€¦" class="border p-1 ml-2" oninput="updateTable()" />
  </div>

  <div class="bg-white shadow rounded p-4 overflow-auto max-h-80 dark:bg-gray-800">
    <table class="table-auto w-full text-sm">
      <thead class="bg-gray-700 text-white sticky top-0">
        <tr>
          <th class="px-2 py-1">Timestamp</th>
          <th class="px-2 py-1">Device</th>
          <th class="px-2 py-1">Flow ID</th>
          <th class="px-2 py-1">TX Hash</th>
        </tr>
      </thead>
      <tbody id="eventsTableBody"></tbody>
    </table>
  </div>

  <div class="bg-white shadow rounded p-4 mt-6 dark:bg-gray-800">
    <canvas id="myChart"></canvas>
  </div>
</div>

<div id="notification" class="fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded shadow hidden"></div>

<script>
const socket = io();

const tableBody = document.getElementById("eventsTableBody");
const deviceFilter = document.getElementById("deviceFilter");
const searchInput = document.getElementById("searchInput");

let allEvents = [];
let deviceCounts = {};
let chart;

const ctx = document.getElementById('myChart').getContext('2d');
chart = new Chart(ctx, {
  type: 'line',
  data: {
    labels: [],
    datasets: [{
      label: 'Nombre dâ€™Ã©vÃ©nements dans le temps',
      data: [],
      fill: false,
      borderColor: 'rgba(75,192,192,1)',
      tension: 0.1
    }]
  },
  options: {
    responsive: true,
    scales: { y: { beginAtZero: true } }
  }
});

// Charger lâ€™historique
fetch('/api/history')
  .then(res => res.json())
  .then(data => {
    allEvents = data;
    data.forEach(e => {
      deviceCounts[e.device] = (deviceCounts[e.device] || 0) + 1;
    });
    updateTable();
    updateChart();
    updateFilterOptions();
  });

socket.on('new_event', data => {
  allEvents.unshift(data);
  if (allEvents.length > 50) allEvents.pop();

  deviceCounts[data.device] = (deviceCounts[data.device] || 0) + 1;

  updateTable();
  updateChart();
  updateFilterOptions();

  showNotification(`Nouveau flow dÃ©tectÃ© sur ${data.device}`);
});

function updateTable() {
  const filterValue = deviceFilter.value;
  const searchValue = searchInput.value.toLowerCase();
  tableBody.innerHTML = '';
  allEvents
    .filter(e => (!filterValue || e.device === filterValue))
    .filter(e => JSON.stringify(e).toLowerCase().includes(searchValue))
    .forEach(e => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td class="px-2 py-1">${e.timestamp}</td>
        <td class="px-2 py-1">${e.device}</td>
        <td class="px-2 py-1">${e.flow_id}</td>
        <td class="px-2 py-1">${e.tx_hash.substring(0,8)}â€¦</td>
      `;
      tableBody.appendChild(row);
    });
}

function updateChart() {
  const timestamps = allEvents.slice().reverse().map(e => e.timestamp);
  const counts = timestamps.map((_, i) => i + 1);
  chart.data.labels = timestamps;
  chart.data.datasets[0].data = counts;
  chart.update();
}

function updateFilterOptions() {
  const devices = Array.from(new Set(allEvents.map(e => e.device)));
  deviceFilter.innerHTML = '<option value="">Tous</option>';
  devices.forEach(d => {
    const opt = document.createElement("option");
    opt.value = d;
    opt.textContent = d;
    deviceFilter.appendChild(opt);
  });
}

function toggleDarkMode() {
  document.body.classList.toggle('dark');
}

function openOnos() {
  window.open("http://localhost:8181/onos/ui", "_blank");
}

function showNotification(message) {
  const notif = document.getElementById("notification");
  notif.textContent = message;
  notif.classList.remove("hidden");
  setTimeout(() => notif.classList.add("hidden"), 3000);
}
</script>

</body>
</html>
